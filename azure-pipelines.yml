trigger:
  - master

stages:
  - stage: build
    displayName: Build
    variables:
      dotnetVersion: 9.x
      nodeVersion: 22.x
    jobs:
      - job: build_api
        displayName: Build API
        pool:
          name: emeni-build-windows
        steps:
          - task: UseDotNet@2
            displayName: Setup .NET $(dotnetVersion)
            inputs:
              packageType: "sdk"
              version: $(dotnetVersion)

          - task: DotNetCoreCLI@2
            displayName: Install dotnet-ef
            continueOnError: true
            inputs:
              command: 'custom'
              custom: 'tool'
              arguments: 'update dotnet-ef --global --ignore-failed-sources'

          - task: DotNetCoreCLI@2
            displayName: Publish API
            inputs:
              command: 'publish'
              publishWebProjects: false
              projects: './src/SimplePlanePerformance.WebAPI'
              zipAfterPublish: false
              configuration: Release
              arguments: -o $(Build.ArtifactStagingDirectory)/ --runtime win-x64

          - task: DotNetCoreCLI@2
            displayName: Generate database migration script
            inputs:
              command: 'custom'
              custom: 'ef'
              arguments: 'migrations script -o $(Build.ArtifactStagingDirectory)/scripts/migrations_$(Build.BuildNumber).sql -i -c SppDataContext -p SimplePlanePerformance.Core.csproj -s ../SimplePlanePerformance.WebAPI/SimplePlanePerformance.WebAPI.csproj'
              workingDirectory: '$(System.DefaultWorkingDirectory)/src/SimplePlanePerformance.Core'

          - task: DeleteFiles@1
            displayName: Delete .pdb files
            inputs:
              SourceFolder: '$(Build.ArtifactStagingDirectory)/'
              Contents: '**/*.pdb'

          - task: PublishBuildArtifacts@1
            displayName: Upload Artifacts
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: simpleplaneperformance-api-win-x64
              publishLocation: 'Container'
      - job: build_client
        displayName: Build Client
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: UseNode@1
            displayName: Setup Node $(nodeVersion)
            inputs:
              version: $(nodeVersion)

          - task: Npm@1
            displayName: Install NPM dependencies
            inputs:
              command: "custom"
              workingDir: "src/SimplePlanePerformance.Client"
              customCommand: "ci"

          - task: Npm@1
            displayName: Build Client (PROD)
            inputs:
              command: "custom"
              workingDir: "src/SimplePlanePerformance.Client"
              customCommand: "run build-prod"

          - task: CopyFiles@2
            displayName: Copy Client (PROD)
            inputs:
              SourceFolder: "$(System.DefaultWorkingDirectory)/src/SimplePlanePerformance.Client/dist/simple-plane-performance.client"
              Contents: "**"
              TargetFolder: "$(Build.ArtifactStagingDirectory)/src/SimplePlanePerformance.Client_PROD"
              CleanTargetFolder: true
              OverWrite: true

          - task: Npm@1
            displayName: Build Client (STAGING)
            inputs:
              command: "custom"
              workingDir: "src/SimplePlanePerformance.Client"
              customCommand: "run build-staging"

          - task: CopyFiles@2
            displayName: Copy Client (STAGING)
            inputs:
              SourceFolder: "$(System.DefaultWorkingDirectory)/src/SimplePlanePerformance.Client/dist/simple-plane-performance.client"
              Contents: "**"
              TargetFolder: "$(Build.ArtifactStagingDirectory)/SimplePlanePerformance.Client_STAGING"
              CleanTargetFolder: true
              OverWrite: true

          - task: Npm@1
            displayName: Build Client (TESTING)
            inputs:
              command: "custom"
              workingDir: "src/SimplePlanePerformance.Client"
              customCommand: "run build-testing"

          - task: CopyFiles@2
            displayName: Copy Client (TESTING)
            inputs:
              SourceFolder: "$(System.DefaultWorkingDirectory)/src/SimplePlanePerformance.Client/dist/simple-plane-performance.client"
              Contents: "**"
              TargetFolder: "$(Build.ArtifactStagingDirectory)/SimplePlanePerformance.Client_TESTING"
              CleanTargetFolder: true
              OverWrite: true

          - task: PublishBuildArtifacts@1
            displayName: Upload Artifacts
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'simpleplaneperformance-client'
              publishLocation: 'Container'
  - stage: deploy_test
    displayName: Deploy to Test
    pool:
      name: emeni-deploy-windows
    variables:
      - group: Emeni.local Deployment Variables
    jobs:
      - job: deploy_api
        displayName: Deploy API
        steps:
          - checkout: none

          - task: DownloadBuildArtifacts@1
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'simpleplaneperformance-api-win-x64'
              downloadPath: '$(System.ArtifactsDirectory)'
              cleanDestinationFolder: true

          - script: dir $(System.ArtifactsDirectory)\simpleplaneperformance-api-win-x64\src'
          
          - task: IISWebAppDeploy@2
            inputs:
              machinesList: 'planeperformance.emeni.local'
              AdminUserName: '$(DeployServiceUserName)'
              AdminPassword: '$(DeployServiceUserPassword)'
              WinRMProtocol: 'Http'
              WebDeployPackage: '$(System.ArtifactsDirectory)\simpleplaneperformance-api-win-x64\src'
              WebsiteName: 'SimplePlanePerformance\env_TEST\api'
              TakeAppOffline: true
          
